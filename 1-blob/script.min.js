function scaleColor(t,i){let s=7===t.length?1:0,h=mf(pi(t.substring(s,s+2),16)*i),e=mf(pi(t.substring(s+2,s+4),16)*i),n=mf(pi(t.substring(s+4,s+6),16)*i);return(1===s?"#":"")+h.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")}function lerpColor(t,i,s){let h=7===t.length?1:0,e=pi(t.substring(h,h+2),16),n=pi(t.substring(h+2,h+4),16),o=pi(t.substring(h+4,h+6),16),c=pi(i.substring(h,h+2),16),r=pi(i.substring(h+2,h+4),16),a=pi(i.substring(h+4,h+6),16),p=mf(e*(1-s)+c*s),l=mf(n*(1-s)+r*s),u=mf(o*(1-s)+a*s);return(1===h?"#":"")+p.toString(16).padStart(2,"0")+l.toString(16).padStart(2,"0")+u.toString(16).padStart(2,"0")}var mf=Math.floor,mr=Math.random,mc=Math.cos,ms=Math.sin,pi=parseInt,sc=0;class Engine{constructor(t,i){this.cX=0,this.cY=0,this.speed=1,this.width=t,this.height=i,this.canvas=document.getElementsByTagName("canvas")[0],this.canvas.width=this.width,this.canvas.height=this.height,this.context=this.canvas.getContext("2d"),this.gameObjects=[],this.texts=[],this.tiles=[];let s=document.createElement("canvas");s.width=2*t,s.height=2*i;let h=s.getContext("2d");h.fillStyle="#475250",h.fillRect(0,0,2*t,2*i);for(let s=0;s<20;s++){h.lineWidth=1;let s=2*mr()*t,e=2*mr()*i,n=200*mr()+50;for(let o=-1;o<=1;o++)for(let c=-1;c<=1;c++)h.beginPath(),h.arc(2*o*t+s,2*c*i+e,n,0,2*Math.PI),h.strokeStyle="#556663",h.stroke()}this.bgData=h.getImageData(0,0,2*t,2*i),this.s10C=document.createElement("canvas"),this.s10C.width=30,this.s10C.height=30;let e=this.s10C.getContext("2d");e.fillStyle="red",e.beginPath(),e.arc(15,15,10,0,2*Math.PI),e.fill();let n=6+mf(3*mr());for(let t=0;t<n;t++){let i=2*t*Math.PI/n+mr()*Math.PI/12,s=Math.cos(i-Math.PI/8),h=Math.sin(i-Math.PI/8),o=Math.cos(i),c=Math.sin(i),r=Math.cos(i+Math.PI/8),a=Math.sin(i+Math.PI/8);e.beginPath(),e.moveTo(10*s+15,10*h+15),e.lineTo(15*o+15,15*c+15),e.lineTo(10*r+15,10*a+15),e.lineTo(10*s+15,10*h+15),e.fillStyle="red",e.fill()}}update(){if(this.updateTiles(),this.gameObjects.forEach(t=>{t.update&&t.update()}),this.blob&&(this.blob.update(),!this.blob.nucFreezing)){let t=.5*(this.blob.pNuc.x+this.blob.pBod.x),i=.5*(this.blob.pNuc.y+this.blob.pBod.y),s=t-this.cX;s>2*this.blob.nucTemp&&(s=2*this.blob.nucTemp),s<2*-this.blob.nucTemp&&(s=2*-this.blob.nucTemp);let h=i-this.cY;h>2*this.blob.nucTemp&&(h=2*this.blob.nucTemp),h<2*-this.blob.nucTemp&&(h=2*-this.blob.nucTemp),this.cX+=s,this.cY+=h}document.getElementById("score").innerText=sc}updateTiles(){if(this.blob){let t=Math.floor(this.blob.pBod.x/2e3),i=Math.floor(this.blob.pBod.y/2e3),s=[],h=0;for(;h<this.tiles.length;){let e=this.tiles[h];Math.abs(e.i-t)<3&&Math.abs(e.j-i)<3?(s.push(e),this.tiles.splice(h,1)):h++}this.tiles.forEach(t=>{t.destroy()});for(let h=-2;h<3;h++)for(let e=-2;e<3;e++)if(!s.find(s=>s.i===t+h&&s.j===i+e)){let n=new Tile(this,t+h,i+e);n.instantiate(),s.push(n)}this.tiles=s}}draw(){let t=-this.cX;for(;t<0;)t+=2*this.width;for(;t>2*this.width;)t-=2*this.width;let i=-this.cY;for(;i<0;)i+=2*this.height;for(;i>2*this.height;)i-=2*this.height;this.context.putImageData(this.bgData,t,i),this.context.putImageData(this.bgData,t-2*this.width,i),this.context.putImageData(this.bgData,t,i-2*this.height),this.context.putImageData(this.bgData,t-2*this.width,i-2*this.height),this.gameObjects.forEach(t=>{t.draw&&t.draw()}),this.blob&&this.blob.draw(),this.texts.forEach(t=>{t.draw&&t.draw()})}}class Tile{constructor(t,i,s){this.e=t,this.i=i,this.j=s,this.x=2e3*i,this.y=2e3*s,this.gos=[]}instantiate(){for(let t=0;t<20;t++){let t=new Stone(this.e,2+mf(5*mr()),5+10*mr());t.p.x=this.x+2e3*mr(),t.p.y=this.y+2e3*mr(),this.gos.push(t)}for(let t=0;t<10;t++){let t=new Spike(this.e,1+mf(3*mr()),2+5*mr());t.p.x=this.x+2e3*mr(),t.p.y=this.y+2e3*mr(),this.gos.push(t)}for(let t=0;t<15;t++){let t=new Coin(this.e,1+mf(3*mr()),2+5*mr());t.p.x=this.x+2e3*mr(),t.p.y=this.y+2e3*mr(),this.gos.push(t)}for(let t=0;t<5;t++){let t,i=Math.random();i<.5?t=new Tunnel(this.e,300):i<1&&(t=new Shell(this.e,200)),t.p.x=this.x+2e3*mr(),t.p.y=this.y+2e3*mr(),t.dir=mr()*Math.PI*2,this.gos.push(t)}this.gos.forEach(t=>{t.instantiate()})}destroy(){this.gos.forEach(t=>{t.destroy()})}}class GameObject{constructor(t){this.en=t}instantiate(){this.en.gameObjects.push(this)}destroy(){let t=this.en.gameObjects.indexOf(this);-1!==t&&this.en.gameObjects.splice(t,1)}}class FloatingText{constructor(t,i){this.en=t,this.t=i,this.s=1,this.k=0,this.p={x:0,y:0},this.dx=2*Math.random()-1,this.dy=2*Math.random()}instantiate(){this.en.texts.push(this)}destroy(){let t=this.en.texts.indexOf(this);-1!==t&&this.en.texts.splice(t,1)}draw(){this.k++,this.s=20*Math.sin(this.k/60*Math.PI);let t=this.en.context,i=.5*this.en.width-this.en.cX,s=.5*this.en.height-this.en.cY,h=i+this.p.x+this.k*this.dx,e=s+this.p.y-2*this.k*this.dy;t.font=this.s.toFixed(0)+"px Arial",t.textAlign="center",t.fillStyle="white",t.fillText(this.t,h,e),this.k>60&&this.destroy()}}class Disc extends GameObject{constructor(t,i,s,h){super(t),this.type="disc",this.s=i,this.r=10*i,this.h=s,this.p={x:0,y:0},this.color=h,this.colorShadow=scaleColor(h,.5)}draw(){let t=this.en.context;t.lineWidth=2;let i=.5*this.en.width-this.en.cX,s=.5*this.en.height-this.en.cY,h=i+this.p.x,e=s+this.p.y;if(h>-20-this.r&&e>-20-this.r&&h<this.en.width+20+this.r&&e<this.en.height+20+this.r){let i=this.h-2*this.h*h/this.en.width,s=this.h-2*this.h*e/this.en.height;t.beginPath(),t.arc(h+i,e+s,this.r,0,2*Math.PI),t.strokeStyle=this.colorShadow,t.stroke(),t.beginPath(),t.arc(h,e,this.r,0,2*Math.PI),t.strokeStyle=this.color,t.stroke()}}collide(t,i,s){let h=t-this.p.x,e=i-this.p.y;return h*h+e*e<(s+this.r)*(s+this.r)}collisionNormal(t,i,s){let h=t-this.p.x,e=i-this.p.y,n=h*h+e*e;if(n<(s+this.r)*(s+this.r)){let t=Math.sqrt(n);return{x:h/t,y:e/t}}}}class Structure extends GameObject{constructor(t,i){super(t),this.dir=0,this.k=0,this.p={x:0,y:0},this.r=i,this.a=0}instantiate(){this.en.gameObjects.push(this),this.coins.forEach(t=>{t.instantiate()}),this.spikes.forEach(t=>{t.instantiate()})}destroy(){let t=this.en.gameObjects.indexOf(this);-1!==t&&this.en.gameObjects.splice(t,1),this.coins.forEach(t=>{t.destroy()}),this.spikes.forEach(t=>{t.destroy()})}update(){let t=mc(this.dir),i=mc(this.dir);this.p.x+=.2*t,this.p.y+=.2*i,this.dir=mc(this.k/1e3)*Math.PI,this.k++,this.a+=Math.PI/1200}}class Tunnel extends Structure{constructor(t,i){super(t,i),this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5)]}update(){super.update();let t=mc(this.a),i=ms(this.a);this.coins.forEach((s,h)=>{s.p.x=t*this.r*(h-2)/3+this.p.x,s.p.y=i*this.r*(h-2)/3+this.p.y}),this.spikes.forEach((s,h)=>{let e=this.coins[h],n=h%2==0?1:-1;s.p.x=e.p.x+n*i*this.r/3,s.p.y=e.p.y-n*t*this.r/3})}}class Shell extends Structure{constructor(t,i){super(t,i),this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5)]}update(){super.update(),this.coins.forEach((t,i)=>{let s=mc(this.a+i*Math.PI/2),h=ms(this.a+i*Math.PI/2);t.p.x=s*this.r/3+this.p.x,t.p.y=h*this.r/3+this.p.y}),this.spikes.forEach((t,i)=>{let s=mc(this.a+i*Math.PI/2),h=ms(this.a+i*Math.PI/2);t.p.x=s*this.r+this.p.x,t.p.y=h*this.r+this.p.y})}}var coins=[];class Coin extends Disc{constructor(t,i,s){super(t,i,s,"#b5eecb"),this.type="coin"}instantiate(){super.instantiate(),coins.push(this)}destroy(){super.destroy();let t=coins.indexOf(this);-1!==t&&coins.splice(t,1)}}class Spike extends Disc{constructor(t,i,s){super(t,i,s,"#f8a2a8"),this.type="spike"}}class Stone extends Disc{constructor(t,i,s){super(t,i,s,"#9589a9"),this.type="stone",this.bump=0,this.bumping=!1}draw(){this.bumping?(this.bump+=1+.5*this.s,this.bumping=this.bump<3*this.size):this.bump=Math.max(this.bump-.5,0);let t=this.en.context;t.lineWidth=2;let i=.5*this.en.width-this.en.cX,s=.5*this.en.height-this.en.cY,h=i+this.p.x,e=s+this.p.y;if(h>-20-this.r&&e>-20-this.r&&h<this.en.width+20+this.r&&e<this.en.height+20+this.r){let i=this.h-2*this.h*h/this.en.width,s=this.h-2*this.h*e/this.en.height;t.beginPath(),t.arc(h+i,e+s,this.r+this.bump,0,2*Math.PI),t.strokeStyle=this.colorShadow,t.stroke(),t.beginPath(),t.arc(h,e,this.r+this.bump,0,2*Math.PI),t.strokeStyle=this.color,t.stroke()}}}class Blob{constructor(t){this.en=t,this.combo=1,this.hpM=20,this.hp=this.hpM,this.springK=6,this.mBod=3,this.mNuc=1,this.nucFreezing=!1,this.nucTemp=1,this.pNuc={x:50,y:30},this.vNuc={x:0,y:0},this.pBod={x:-50,y:20},this.vBod={x:0,y:0},this.pAnchor={x:0,y:0}}draw(){let t=this.en.context,i=.5*this.en.width-this.en.cX,s=.5*this.en.height-this.en.cY,h=30,e=this.pBod.x-this.pNuc.x,n=this.pBod.y-this.pNuc.y,o=Math.sqrt(e*e+n*n);e/=o,n/=o,h-=o/10,h=Math.max(h,20);let c=scaleColor("#b5eecb",this.hp/this.hpM);t.beginPath(),t.arc(i+this.pBod.x,s+this.pBod.y,h+2,0,2*Math.PI),t.fillStyle=c,t.fill();for(let h=0;h<.5*o;h+=2){let c=1-h/(.5*o),r=20*(c*=c)+10*(1-c);t.beginPath(),t.arc(i+this.pNuc.x+e*h,s+this.pNuc.y+n*h,r+2,0,2*Math.PI),t.fill()}for(let c=.5*o;c<o;c+=2){let r=(c-.5*o)/(.5*o),a=10*(1-(r=Math.pow(r,1.5)))+h*r;t.beginPath(),t.arc(i+this.pNuc.x+e*c,s+this.pNuc.y+n*c,a+2,0,2*Math.PI),t.fill()}t.beginPath(),t.arc(i+this.pNuc.x,s+this.pNuc.y,22,0,2*Math.PI),t.fill(),t.fillStyle="#475250",t.beginPath(),t.arc(i+this.pBod.x,s+this.pBod.y,h,0,2*Math.PI),t.fill();for(let h=0;h<.5*o;h+=2){let c=1-h/(.5*o),r=20*(c*=c)+10*(1-c);t.beginPath(),t.arc(i+this.pNuc.x+e*h,s+this.pNuc.y+n*h,r,0,2*Math.PI),t.fill()}for(let c=.5*o;c<o;c+=2){let r=(c-.5*o)/(.5*o),a=10*(1-(r=Math.pow(r,1.5)))+h*r;t.beginPath(),t.arc(i+this.pNuc.x+e*c,s+this.pNuc.y+n*c,a,0,2*Math.PI),t.fill()}t.beginPath(),t.arc(i+this.pNuc.x,s+this.pNuc.y,20,0,2*Math.PI),t.fill(),this.nucFreezing&&(t.beginPath(),t.arc(i+this.pAnchor.x,s+this.pAnchor.y,10,0,2*Math.PI),t.fillStyle="red",t.fill())}update(){this.nucFreezing?this.nucTemp-=1/120:(this.nucTemp+=1/90,this.nucTemp=Math.min(this.nucTemp,1)),this.nucTemp<0&&(this.nucFreezing=!1,this.nucTemp=0);let t=this.pBod.x-this.pNuc.x,i=this.pBod.y-this.pNuc.y,s=Math.sqrt(t*t+i*i);if(s>0){let h=-(t/=s),e=-(i/=s);this.vNuc.x+=t*s*this.springK/60/this.mNuc,this.vNuc.y+=i*s*this.springK/60/this.mNuc,this.vBod.x+=h*s*this.springK/60/this.mBod,this.vBod.y+=e*s*this.springK/60/this.mBod}let h=(coins=coins.sort((t,i)=>{let s=t.p.x-this.pNuc.x;s*=s;let h=t.p.y-this.pNuc.y;h*=h;let e=i.p.x-this.pNuc.x;e*=e;let n=i.p.y-this.pNuc.y;return s+h-(e+(n*=n))}))[0];if(h){let t=h.p.x-this.pNuc.x,i=h.p.y-this.pNuc.y,s=Math.sqrt(t*t+i*i);if(s>0){t/=s,i/=s;let h=100/(s/100)/(s/100);t*=h/60/this.mNuc,i*=h/60/this.mNuc,this.vNuc.x+=t,this.vNuc.y+=i}}if(this.nucFreezing){let t=this.pAnchor.x-this.pBod.x,i=this.pAnchor.y-this.pBod.y,s=Math.sqrt(t*t+i*i);s>0&&(t/=s,i/=s,this.vBod.x+=t*s*this.springK*100/60/this.mBod,this.vBod.y+=i*s*this.springK*100/60/this.mBod)}this.vNuc.x*=.99*this.nucTemp,this.vNuc.y*=.99*this.nucTemp,this.vBod.x*=.9925*(.8+(this.nucFreezing?0:.2)),this.vBod.y*=.9925*(.8+(this.nucFreezing?0:.2));for(let t=0;t<this.en.gameObjects.length;t++){let i=this.en.gameObjects[t];if(i.collide){if(i.collide(this.pBod.x,this.pBod.y,30))if("stone"===i.type){let t=i.collisionNormal(this.pBod.x,this.pBod.y,30),s=this.vBod.x*t.x+this.vBod.y*t.y;this.pBod.x=i.p.x+t.x*(30+i.r+1),this.pBod.y=i.p.y+t.y*(30+i.r+1),this.vBod.x-=2*s*t.x,this.vBod.y-=2*s*t.y,i.bumping=!0;let h=new FloatingText(this.en,"BUMP !");h.p.x=this.pBod.x,h.p.y=this.pBod.y,h.instantiate()}else"spike"===i.type&&(this.hp=Math.max(this.hp-2*i.s,0),i.destroy(),this.combo=1);if(i.collide(this.pNuc.x,this.pNuc.y,20))if("stone"===i.type){let t=i.collisionNormal(this.pNuc.x,this.pNuc.y,20),s=this.vNuc.x*t.x+this.vNuc.y*t.y;this.pNuc.x=i.p.x+t.x*(20+i.r+1),this.pNuc.y=i.p.y+t.y*(20+i.r+1),this.vNuc.x-=2*s*t.x,this.vNuc.y-=2*s*t.y,i.bumping=!0;let h=new FloatingText(this.en,"BUMP !");h.p.x=this.pNuc.x,h.p.y=this.pNuc.y,h.instantiate()}else if("coin"===i.type){sc+=i.s*this.combo;let t=new FloatingText(this.en,"+ "+(i.s*this.combo).toFixed(0));t.p.x=this.pBod.x,t.p.y=this.pBod.y,t.instantiate(),this.hp=Math.min(this.hp+i.s,this.hpM),i.destroy(),this.combo+=1}else"spike"===i.type&&(this.hp=Math.max(this.hp-2*i.s,0),i.destroy(),this.combo=1)}}this.pNuc.x+=this.vNuc.x/60,this.pNuc.y+=this.vNuc.y/60,this.pBod.x+=this.vBod.x/60,this.pBod.y+=this.vBod.y/60}}window.addEventListener("load",()=>{let t=new Engine(700,700),i=new Blob(t);t.blob=i;let s=()=>{t.update(),t.draw(),requestAnimationFrame(s)};s(),t.canvas.addEventListener("pointerdown",s=>{1===i.nucTemp&&(i.combo=1,i.nucFreezing=!0,i.pAnchor.x=s.clientX-9+t.cX-.5*t.width,i.pAnchor.y=s.clientY-9+t.cY-.5*t.height)}),t.canvas.addEventListener("pointermove",s=>{i.nucFreezing&&(i.pAnchor.x=s.clientX-9+t.cX-.5*t.width,i.pAnchor.y=s.clientY-9+t.cY-.5*t.height)}),t.canvas.addEventListener("pointerup",t=>{i.nucFreezing&&(i.nucFreezing=!1,i.nucTemp=0)})});