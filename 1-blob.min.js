function scaleColor(t,s){let e=7===t.length?1:0,i=mf(pi(t.substring(e,e+2),16)*s),h=mf(pi(t.substring(e+2,e+4),16)*s),n=mf(pi(t.substring(e+4,e+6),16)*s);return(1===e?"#":"")+i.toString(16).padStart(2,"0")+h.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")}function lerpColor(t,s,e){let i=7===t.length?1:0,h=pi(t.substring(i,i+2),16),n=pi(t.substring(i+2,i+4),16),r=pi(t.substring(i+4,i+6),16),p=pi(s.substring(i,i+2),16),o=pi(s.substring(i+2,i+4),16),a=pi(s.substring(i+4,i+6),16),l=mf(h*(1-e)+p*e),c=mf(n*(1-e)+o*e),y=mf(r*(1-e)+a*e);return(1===i?"#":"")+l.toString(16).padStart(2,"0")+c.toString(16).padStart(2,"0")+y.toString(16).padStart(2,"0")}function play(){if(playing)return;document.getElementById("play").style.display="none",playing=!0;let t=new Engine(cw,ch),s=new Blob(t);t.blob=s;let e=()=>{t.update(),t.draw(),playing?requestAnimationFrame(e):t.destroy()};e(),t.cnv.addEventListener("pointerdown",e=>{if(1===s.nT){s.cbo=1,s.pA.x=e.clientX-9+t.cX-.5*t.w,s.pA.y=e.clientY-9+t.cY-.5*t.h;let i=s.pA.x-s.pB.x,h=s.pA.y-s.pB.y;i*i+h*h<3600&&(s.nFrz=!0)}}),t.cnv.addEventListener("pointermove",e=>{s.nFrz&&(s.pA.x=e.clientX-9+t.cX-.5*t.w,s.pA.y=e.clientY-9+t.cY-.5*t.h)}),t.cnv.addEventListener("pointerup",t=>{s.nFrz&&s.brk()})}function gameover(){document.getElementById("play").style.display="",playing=!1}var gk=0,mf=Math.floor,mr=Math.random,mc=Math.cos,ms=Math.sin,pi=parseInt,sc=0,cBlk="#475250",cLBlk="#556663",cGrn="#b5eecb";class Engine{constructor(t,s){let e=this;e.cX=0,e.cY=0,e.w=t,e.h=s,e.cnv=document.getElementsByTagName("canvas")[0],e.cnv.width=e.w,e.cnv.height=e.h,e.ctx=e.cnv.getContext("2d"),e.gos=[],e.txts=[],e.tiles=[];let i=document.createElement("canvas");i.width=2*t,i.height=2*s;let h=i.getContext("2d");h.fillStyle=cBlk,h.fillRect(0,0,2*t,2*s);for(let e=0;e<20;e++){h.lineWidth=1;let e=2*mr()*t,i=2*mr()*s,n=200*mr()+50;for(let r=-1;r<=1;r++)for(let p=-1;p<=1;p++)h.beginPath(),h.arc(2*r*t+e,2*p*s+i,n,0,2*Math.PI),h.strokeStyle=cLBlk,h.stroke()}e.bgData=h.getImageData(0,0,2*t,2*s)}destroy(){for(;this.gos[0];)this.gos[0].destroy()}update(){let t=this;if(gk++,t.updateTiles(),t.gos.forEach(t=>{t.update&&t.update()}),t.blob&&(t.blob.update(),!t.blob.nFrz)){let s=.5*(t.blob.pN.x+t.blob.pB.x),e=.5*(t.blob.pN.y+t.blob.pB.y),i=s-t.cX;i>2*t.blob.nT&&(i=2*t.blob.nT),i<2*-t.blob.nT&&(i=2*-t.blob.nT);let h=e-t.cY;h>2*t.blob.nT&&(h=2*t.blob.nT),h<2*-t.blob.nT&&(h=2*-t.blob.nT),t.cX+=i,t.cY+=h}document.getElementById("score").innerText=sc.toFixed(0).padStart(6,"0")}updateTiles(){let t=this;if(t.blob){let s=Math.floor(t.blob.pB.x/2e3),e=Math.floor(t.blob.pB.y/2e3),i=[],h=0;for(;h<t.tiles.length;){let n=t.tiles[h];Math.abs(n.i-s)<3&&Math.abs(n.j-e)<3?(i.push(n),t.tiles.splice(h,1)):h++}t.tiles.forEach(t=>{t.destroy()});for(let h=-1;h<2;h++)for(let n=-1;n<2;n++)if(!i.find(t=>t.i===s+h&&t.j===e+n)){let r=new Tile(t,s+h,e+n);r.instantiate(),i.push(r)}t.tiles=i}t.tiles.forEach(t=>{t.update()})}draw(){let t=this,s=-t.cX;for(;s<0;)s+=2*t.w;for(;s>2*t.w;)s-=2*t.w;let e=-t.cY;for(;e<0;)e+=2*t.h;for(;e>2*t.h;)e-=2*t.h;t.ctx.putImageData(t.bgData,s,e),t.ctx.putImageData(t.bgData,s-2*t.w,e),t.ctx.putImageData(t.bgData,s,e-2*t.h),t.ctx.putImageData(t.bgData,s-2*t.w,e-2*t.h),t.gos.forEach(t=>{t.draw&&t.draw()}),t.blob&&t.blob.draw(),t.txts.forEach(t=>{t.draw&&t.draw()})}}class Tile{constructor(t,s,e){let i=this;i.en=t,i.i=s,i.j=e,i.x=2e3*s,i.y=2e3*e,i.k=0,i.stns=[],i.spks=[],i.cons=[],i.strs=[]}rx(){return this.x+2e3*mr()}ry(){return this.y+2e3*mr()}addStone(){let t=new Stone(this,2+mf(5*mr()),5+10*mr());t.p.x=this.rx(),t.p.y=this.ry(),this.check(t.p.x,t.p.y)&&(t.instantiate(),this.stns.push(t))}addSpike(){let t=new Spike(this,1+mf(3*mr()),2+5*mr());t.p.x=this.rx(),t.p.y=this.ry(),this.check(t.p.x,t.p.y)&&(t.instantiate(),this.spks.push(t))}addCoin(){let t=new Coin(this,1+mf(3*mr()),2+5*mr());t.p.x=this.rx(),t.p.y=this.ry(),this.check(t.p.x,t.p.y)&&(t.instantiate(),this.cons.push(t))}addStruct(){let t,s=mr();t=s<.25?new Tunnel(this,300):s<.5?new Shell(this,200):s<.75?new Snake(this,400):new HotCore(this,150),t.p.x=this.rx(),t.p.y=this.ry(),this.check(t.p.x,t.p.y)&&(t.dir=mr()*Math.PI*2,t.instantiate(),this.strs.push(t))}check(t,s){return Math.abs(t-this.en.blob.pB.x)>200&&Math.abs(t-this.en.blob.pB.x)>200}instantiate(){for(let t=0;t<20;t++)this.addStone();for(let t=0;t<8;t++)this.addSpike();for(let t=0;t<12;t++)this.addCoin();for(let t=0;t<4;t++)this.addStruct()}destroy(){let t=[...this.stns,...this.spks,...this.cons,...this.strs];t.forEach(t=>{t.destroy(!0)})}update(){this.cons.length<12*(1+gk/3600)&&this.addCoin(),this.spks.length<8*(1+gk/3600)&&this.addSpike(),this.strs.length<4*(1+gk/3600)&&this.addStruct()}}class GameObject{constructor(t){this.t=t,this.en=t.en}instantiate(){this.en.gos.push(this)}destroy(){let t=this.en.gos.indexOf(this);-1!==t&&this.en.gos.splice(t,1),this.dstryd=!0}}class FloatingText{constructor(t,s){this.en=t,this.t=s,this.s=1,this.k=0,this.p={x:0,y:0},this.dx=2*mr()-1,this.dy=2*mr()}instantiate(){this.en.txts.push(this)}destroy(){let t=this.en.txts.indexOf(this);-1!==t&&this.en.txts.splice(t,1)}draw(){this.k++,this.s=20*Math.sin(this.k/60*Math.PI);let t=this.en.ctx,s=.5*this.en.w-this.en.cX,e=.5*this.en.h-this.en.cY,i=s+this.p.x+this.k*this.dx,h=e+this.p.y-2*this.k*this.dy;t.font=this.s.toFixed(0)+"px Arial",t.textAlign="center",t.fillStyle="white",t.fillText(this.t,i,h),this.k>60&&this.destroy()}}class Disc extends GameObject{constructor(t,s,e,i){super(t),this.type="disc",this.s=s,this.r=10*s,this.h=e,this.p={x:0,y:0},this.color=i,this.colorShadow=scaleColor(i,.5)}destroy(t){if(!t){let t=new DstryDisc(this);t.instantiate()}super.destroy()}draw(){let t=this,s=t.en.ctx;s.lineWidth=2;let e=.5*t.en.w-t.en.cX,i=.5*t.en.h-t.en.cY,h=e+t.p.x,n=i+t.p.y;if(h>-20-t.r&&n>-20-t.r&&h<t.en.w+20+t.r&&n<t.en.h+20+t.r){let e=t.h-2*t.h*h/t.en.w,i=t.h-2*t.h*n/t.en.h;s.beginPath(),s.arc(h+e,n+i,t.r,0,2*Math.PI),s.strokeStyle=t.colorShadow,s.stroke(),s.beginPath(),s.arc(h,n,t.r,0,2*Math.PI),s.strokeStyle=t.color,s.stroke()}}collide(t,s,e){let i=t-this.p.x,h=s-this.p.y,n=i*i+h*h;return n<(e+this.r)*(e+this.r)}collisionNormal(t,s,e){let i=t-this.p.x,h=s-this.p.y,n=i*i+h*h;if(n<(e+this.r)*(e+this.r)){let t=Math.sqrt(n),s={x:i/t,y:h/t};return s}}}class DstryDisc extends Disc{constructor(t){super(t.t,t.s,t.h,t.color),this.type="dstryd",this.p=t.p}destroy(){super.destroy(!0)}update(){this.r*=.8,this.r<1&&this.destroy()}}class Structure extends GameObject{constructor(t,s){super(t),this.dir=0,this.k=0,this.p={x:0,y:0},this.r=s,this.a=0}instantiate(){this.en.gos.push(this),this.coins.forEach(t=>{t.instantiate()}),this.spikes.forEach(t=>{t.instantiate()})}destroy(){let t=this.en.gos.indexOf(this);-1!==t&&this.en.gos.splice(t,1),t=this.t.strs.indexOf(this),-1!==t&&this.t.strs.splice(t,1),this.coins.forEach(t=>{t.destroy()}),this.spikes.forEach(t=>{t.destroy()})}check(){let t=!1;return this.coins.forEach(s=>{s.dstryd||(t=!0)}),t?(t=!1,this.spikes.forEach(s=>{s.dstryd||(t=!0)}),!!t||(this.destroy(),!1)):(this.destroy(),!1)}update(){let t=mc(this.dir),s=mc(this.dir);this.p.x+=.2*t,this.p.y+=.2*s,this.dir=mc(this.k/1e3)*Math.PI,this.k++,this.a+=Math.PI/1200}}class Tunnel extends Structure{constructor(t,s){super(t,s),this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5)]}update(){if(this.check()){super.update();let t=mc(this.a),s=ms(this.a);this.coins.forEach((e,i)=>{e.p.x=t*this.r*(i-2)/3+this.p.x,e.p.y=s*this.r*(i-2)/3+this.p.y}),this.spikes.forEach((e,i)=>{let h=this.coins[i],n=i%2==0?1:-1;e.p.x=h.p.x+n*s*this.r/3,e.p.y=h.p.y-n*t*this.r/3})}}}class Shell extends Structure{constructor(t,s){super(t,s),this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5)]}update(){this.check()&&(super.update(),this.coins.forEach((t,s)=>{let e=mc(this.a+s*Math.PI/2),i=ms(this.a+s*Math.PI/2);t.p.x=e*this.r/3+this.p.x,t.p.y=i*this.r/3+this.p.y}),this.spikes.forEach((t,s)=>{let e=mc(this.a+s*Math.PI/2),i=ms(this.a+s*Math.PI/2);t.p.x=e*this.r+this.p.x,t.p.y=i*this.r+this.p.y}))}}class HotCore extends Structure{constructor(t,s){super(t,s),this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5)]}update(){if(this.check()){super.update();let t=this;t.coins.forEach((s,e)=>{let i=mc(t.a+e*Math.PI/2),h=ms(t.a+e*Math.PI/2);s.p.x=i*t.r+t.p.x,s.p.y=h*t.r+t.p.y}),t.spikes.forEach((s,e)=>{let i=mc(t.a+e*Math.PI/2+Math.PI/4),h=ms(t.a+e*Math.PI/2+Math.PI/4);s.p.x=i*t.r*.5+t.p.x,s.p.y=h*t.r*.5+t.p.y})}}}class Snake extends Structure{constructor(t,s){super(t),this.l=s,this.r=s/6,this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5)]}update(){if(this.check()){let t=this.en.blob,s=t.pN.x-this.p.x,e=t.pN.y-this.p.y,i=Math.sqrt(s*s+e*e);s/=i,e/=i,i<250?(this.p.x+=.5*s,this.p.y+=.5*e):super.update(),this.spikes[0].p.x=this.p.x,this.spikes[0].p.y=this.p.y;let h=this.spikes[0];for(let t=0;t<this.coins.length;t++){let s=this.coins[t];if(s){let t=s.p.x-h.p.x,e=s.p.y-h.p.y,i=t*t+e*e;i>this.r*this.r&&(i=Math.sqrt(i),t/=i,e/=i,s.p.x=h.p.x+t*this.r,s.p.y=h.p.y+e*this.r),h=s}}}}}var coins=[];class Coin extends Disc{constructor(t,s,e){super(t,s,e,"#b5eecb"),this.type="coin"}instantiate(){super.instantiate(),coins.push(this)}destroy(){super.destroy();let t=coins.indexOf(this);-1!==t&&coins.splice(t,1),t=this.t.cons.indexOf(this),-1!==t&&this.t.cons.splice(t,1)}}class Spike extends Disc{constructor(t,s,e){super(t,s,e,"#f8a2a8"),this.type="spike"}destroy(){super.destroy();let t=this.t.spks.indexOf(this);-1!==t&&this.t.spks.splice(t,1)}}class Stone extends Disc{constructor(t,s,e){super(t,s,e,"#9589a9"),this.type="stone",this.bmp=0,this.bmpg=!1}draw(){let t=this;t.bmpg?(t.bmp+=1+.5*t.s,t.bmpg=t.bmp<3*t.size):t.bmp=Math.max(t.bmp-.5,0);let s=t.en.ctx;s.lineWidth=2;let e=.5*t.en.w-t.en.cX,i=.5*t.en.h-t.en.cY,h=e+t.p.x,n=i+t.p.y;if(h>-20-t.r&&n>-20-t.r&&h<t.en.w+20+t.r&&n<t.en.h+20+t.r){let e=t.h-2*t.h*h/t.en.w,i=t.h-2*t.h*n/t.en.h;s.beginPath(),s.arc(h+e,n+i,t.r+t.bmp,0,2*Math.PI),s.strokeStyle=t.colorShadow,s.stroke(),s.beginPath(),s.arc(h,n,t.r+t.bmp,0,2*Math.PI),s.strokeStyle=t.color,s.stroke()}}}class Blob{constructor(t){let s=this;s.en=t,s.cbo=1,s.hpM=20,s.hp=s.hpM,s.sk=6,s.mBod=3,s.mNuc=1,s.nFrz=!1,s.nT=1,s.pN={x:50,y:30},s.vN={x:0,y:0},s.pB={x:-50,y:20},s.vB={x:0,y:0},s.pA={x:0,y:0},s.flk=0}draw(){let t=this;if(!playing)return;let s=t.en.ctx,e=.5*t.en.w-t.en.cX,i=.5*t.en.h-t.en.cY,h=20,n=30,r=t.pB.x-t.pN.x,p=t.pB.y-t.pN.y,o=Math.sqrt(r*r+p*p);r/=o,p/=o,n-=o/10,n=Math.max(n,h),t.flk=Math.max(t.flk-1,0);let a=lerpColor(cGrn,cBlk,1-t.hp/t.hpM);if(t.flk>0){let s=.5*Math.cos(t.flk*Math.PI*2/60*6)+.5;a=lerpColor(a,"#f8a2a8",s)}s.beginPath(),s.arc(e+t.pB.x,i+t.pB.y,n+2,0,2*Math.PI),s.fillStyle=a,s.fill();for(let n=0;n<.5*o;n+=2){let a=1-n/(.5*o);a*=a;let l=h*a+.5*h*(1-a);s.beginPath(),s.arc(e+t.pN.x+r*n,i+t.pN.y+p*n,l+2,0,2*Math.PI),s.fill()}for(let a=.5*o;a<o;a+=2){let l=(a-.5*o)/(.5*o);l=Math.pow(l,1.5);let c=.5*h*(1-l)+n*l;s.beginPath(),s.arc(e+t.pN.x+r*a,i+t.pN.y+p*a,c+2,0,2*Math.PI),s.fill()}s.beginPath(),s.arc(e+t.pN.x,i+t.pN.y,h+2,0,2*Math.PI),s.fill(),s.fillStyle=cBlk,s.beginPath(),s.arc(e+t.pB.x,i+t.pB.y,n,0,2*Math.PI),s.fill();for(let n=0;n<.5*o;n+=2){let a=1-n/(.5*o);a*=a;let l=h*a+.5*h*(1-a);s.beginPath(),s.arc(e+t.pN.x+r*n,i+t.pN.y+p*n,l,0,2*Math.PI),s.fill()}for(let a=.5*o;a<o;a+=2){let l=(a-.5*o)/(.5*o);l=Math.pow(l,1.5);let c=.5*h*(1-l)+n*l;s.beginPath(),s.arc(e+t.pN.x+r*a,i+t.pN.y+p*a,c,0,2*Math.PI),s.fill()}s.beginPath(),s.arc(e+t.pN.x,i+t.pN.y,h,0,2*Math.PI),s.fill()}brk(){this.nFrz=!1,this.nT=0}update(){let t=this;t.hp<=0&&gameover(),t.nFrz?t.nT-=1/120:(t.nT+=1/90,t.nT=Math.min(t.nT,1)),t.nT<0&&t.brk;let s=t.pB.x-t.pN.x,e=t.pB.y-t.pN.y,i=Math.sqrt(s*s+e*e);if(i>0){s/=i,e/=i;let h=-s,n=-e;t.vN.x+=s*i*t.sk/60/t.mNuc,t.vN.y+=e*i*t.sk/60/t.mNuc,t.vB.x+=h*i*t.sk/60/t.mBod,t.vB.y+=n*i*t.sk/60/t.mBod}coins=coins.sort((s,e)=>{let i=s.p.x-t.pN.x;i*=i;let h=s.p.y-t.pN.y;h*=h;let n=e.p.x-t.pN.x;n*=n;let r=e.p.y-t.pN.y;return r*=r,i+h-(n+r)});let h=coins[0];if(h){let s=h.p.x-t.pN.x,e=h.p.y-t.pN.y,i=Math.sqrt(s*s+e*e);if(i>0){s/=i,e/=i;let h=50/(i/100)/(i/100);s*=h/60/t.mNuc,e*=h/60/t.mNuc,t.vN.x+=s,t.vN.y+=e}}if(t.nFrz){let s=t.pA.x-t.pB.x,e=t.pA.y-t.pB.y,i=Math.sqrt(s*s+e*e);i>0&&(s/=i,e/=i,t.vB.x+=s*i*t.sk*100/60/t.mBod,t.vB.y+=e*i*t.sk*100/60/t.mBod)}t.vN.x*=.99*t.nT,t.vN.y*=.99*t.nT,t.vB.x*=.9925*(.8+(t.nFrz?0:.2)),t.vB.y*=.9925*(.8+(t.nFrz?0:.2));for(let s=0;s<t.en.gos.length;s++){let e=t.en.gos[s];if(e.collide){let s=e.collide(t.pB.x,t.pB.y,30);if(s)if("stone"===e.type){let s=e.collisionNormal(t.pB.x,t.pB.y,30),i=t.vB.x*s.x+t.vB.y*s.y;t.pB.x=e.p.x+s.x*(30+e.r+1),t.pB.y=e.p.y+s.y*(30+e.r+1),t.vB.x-=2*i*s.x,t.vB.y-=2*i*s.y,e.bmpg=!0}else"spike"===e.type&&(t.flk=60,t.hp=Math.max(t.hp-e.s,0),e.destroy(),t.cbo=1);let i=e.collide(t.pN.x,t.pN.y,20);if(i)if("stone"===e.type){let s=e.collisionNormal(t.pN.x,t.pN.y,20),i=t.vN.x*s.x+t.vN.y*s.y;t.pN.x=e.p.x+s.x*(20+e.r+1),t.pN.y=e.p.y+s.y*(20+e.r+1),t.vN.x-=2*i*s.x,t.vN.y-=2*i*s.y,e.bmpg=!0}else if("coin"===e.type){sc+=e.s*t.cbo;let s=new FloatingText(t.en,"+ "+(e.s*t.cbo).toFixed(0));s.p.x=t.pB.x,s.p.y=t.pB.y,s.instantiate(),e.destroy(),t.cbo+=1}else"spike"===e.type&&(t.flk=60,t.hp=Math.max(t.hp-e.s,0),e.destroy(),t.cbo=1)}}t.pN.x+=t.vN.x/60,t.pN.y+=t.vN.y/60,t.pB.x+=t.vB.x/60,t.pB.y+=t.vB.y/60}}var cw=700,ch=700,playing=!1;window.addEventListener("load",()=>{let t=document.getElementById("play");t.style.width="300px",t.style.left="200px",t.style.top="300px",play(),requestAnimationFrame(gameover)});