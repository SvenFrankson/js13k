function scaleColor(t,s){let i=7===t.length?1:0,h=mf(pi(t.substring(i,i+2),16)*s),e=mf(pi(t.substring(i+2,i+4),16)*s),n=mf(pi(t.substring(i+4,i+6),16)*s);return(1===i?"#":"")+h.toString(16).padStart(2,"0")+e.toString(16).padStart(2,"0")+n.toString(16).padStart(2,"0")}function lerpColor(t,s,i){let h=7===t.length?1:0,e=pi(t.substring(h,h+2),16),n=pi(t.substring(h+2,h+4),16),r=pi(t.substring(h+4,h+6),16),p=pi(s.substring(h,h+2),16),o=pi(s.substring(h+2,h+4),16),a=pi(s.substring(h+4,h+6),16),l=mf(e*(1-i)+p*i),c=mf(n*(1-i)+o*i),y=mf(r*(1-i)+a*i);return(1===h?"#":"")+l.toString(16).padStart(2,"0")+c.toString(16).padStart(2,"0")+y.toString(16).padStart(2,"0")}function play(){if(playing)return;document.getElementById("play").style.display="none",playing=!0;let t=new Engine(cw,ch),s=new Blob(t);t.blob=s;let i=()=>{t.update(),t.draw(),playing?requestAnimationFrame(i):t.destroy()};i(),t.cnv.addEventListener("pointerdown",i=>{1===s.nT&&(s.combo=1,s.nFrz=!0,s.pA.x=i.clientX-9+t.cX-.5*t.w,s.pA.y=i.clientY-9+t.cY-.5*t.h)}),t.cnv.addEventListener("pointermove",i=>{s.nFrz&&(s.pA.x=i.clientX-9+t.cX-.5*t.w,s.pA.y=i.clientY-9+t.cY-.5*t.h)}),t.cnv.addEventListener("pointerup",t=>{s.nFrz&&(s.nFrz=!1,s.nT=0)})}function gameover(){document.getElementById("play").style.display="",playing=!1}var gk=0,mf=Math.floor,mr=Math.random,mc=Math.cos,ms=Math.sin,pi=parseInt,sc=0,cBlk="#475250",cLBlk="#556663",cGrn="#b5eecb";class Engine{constructor(t,s){this.cX=0,this.cY=0,this.speed=1,this.w=t,this.h=s,this.cnv=document.getElementsByTagName("canvas")[0],this.cnv.width=this.w,this.cnv.height=this.h,this.ctx=this.cnv.getContext("2d"),this.gos=[],this.txts=[],this.tiles=[];let i=document.createElement("canvas");i.width=2*t,i.height=2*s;let h=i.getContext("2d");h.fillStyle=cBlk,h.fillRect(0,0,2*t,2*s);for(let i=0;i<20;i++){h.lineWidth=1;let i=2*mr()*t,e=2*mr()*s,n=200*mr()+50;for(let r=-1;r<=1;r++)for(let p=-1;p<=1;p++)h.beginPath(),h.arc(2*r*t+i,2*p*s+e,n,0,2*Math.PI),h.strokeStyle=cLBlk,h.stroke()}this.bgData=h.getImageData(0,0,2*t,2*s)}destroy(){for(;this.gos[0];)this.gos[0].destroy()}update(){if(gk++,this.updateTiles(),this.gos.forEach(t=>{t.update&&t.update()}),this.blob&&(this.blob.update(),!this.blob.nFrz)){let t=.5*(this.blob.pN.x+this.blob.pB.x),s=.5*(this.blob.pN.y+this.blob.pB.y),i=t-this.cX;i>2*this.blob.nT&&(i=2*this.blob.nT),i<2*-this.blob.nT&&(i=2*-this.blob.nT);let h=s-this.cY;h>2*this.blob.nT&&(h=2*this.blob.nT),h<2*-this.blob.nT&&(h=2*-this.blob.nT),this.cX+=i,this.cY+=h}document.getElementById("score").innerText=sc}updateTiles(){if(this.blob){let t=Math.floor(this.blob.pB.x/2e3),s=Math.floor(this.blob.pB.y/2e3),i=[],h=0;for(;h<this.tiles.length;){let e=this.tiles[h];Math.abs(e.i-t)<3&&Math.abs(e.j-s)<3?(i.push(e),this.tiles.splice(h,1)):h++}this.tiles.forEach(t=>{t.destroy()});for(let h=-1;h<2;h++)for(let e=-1;e<2;e++)if(!i.find(i=>i.i===t+h&&i.j===s+e)){let n=new Tile(this,t+h,s+e);n.instantiate(),i.push(n)}this.tiles=i}this.tiles.forEach(t=>{t.update()})}draw(){let t=-this.cX;for(;t<0;)t+=2*this.w;for(;t>2*this.w;)t-=2*this.w;let s=-this.cY;for(;s<0;)s+=2*this.h;for(;s>2*this.h;)s-=2*this.h;this.ctx.putImageData(this.bgData,t,s),this.ctx.putImageData(this.bgData,t-2*this.w,s),this.ctx.putImageData(this.bgData,t,s-2*this.h),this.ctx.putImageData(this.bgData,t-2*this.w,s-2*this.h),this.gos.forEach(t=>{t.draw&&t.draw()}),this.blob&&this.blob.draw(),this.txts.forEach(t=>{t.draw&&t.draw()})}}class Tile{constructor(t,s,i){this.en=t,this.i=s,this.j=i,this.x=2e3*s,this.y=2e3*i,this.k=0,this.stns=[],this.spks=[],this.cons=[],this.strs=[]}addStone(){let t=new Stone(this,2+mf(5*mr()),5+10*mr());t.p.x=this.x+2e3*mr(),t.p.y=this.y+2e3*mr(),t.instantiate(),this.stns.push(t)}addSpike(){let t=new Spike(this,1+mf(3*mr()),2+5*mr());t.p.x=this.x+2e3*mr(),t.p.y=this.y+2e3*mr(),t.instantiate(),this.spks.push(t)}addCoin(){let t=new Coin(this,1+mf(3*mr()),2+5*mr());t.p.x=this.x+2e3*mr(),t.p.y=this.y+2e3*mr(),t.instantiate(),this.cons.push(t)}addStruct(){let t,s=mr();t=s<.25?new Tunnel(this,300):s<.5?new Shell(this,200):s<.75?new Snake(this,400):new HotCore(this,150),t.p.x=this.x+2e3*mr(),t.p.y=this.y+2e3*mr(),t.dir=mr()*Math.PI*2,t.instantiate(),this.strs.push(t)}instantiate(){for(let t=0;t<20*(1+gk/3600);t++)this.addStone();for(let t=0;t<10*(1+gk/3600);t++)this.addSpike();for(let t=0;t<15*(1+gk/3600);t++)this.addCoin();for(let t=0;t<5*(1+gk/3600);t++)this.addStruct()}destroy(){let t=[...this.stns,...this.spks,...this.cons,...this.strs];t.forEach(t=>{t.destroy(!0)})}update(){this.cons.length<15&&this.addCoin(),this.spks.length<10&&this.addSpike(),this.strs.length<5&&this.addStruct()}}class GameObject{constructor(t){this.t=t,this.en=t.en}instantiate(){this.en.gos.push(this)}destroy(){let t=this.en.gos.indexOf(this);-1!==t&&this.en.gos.splice(t,1),this.dstryd=!0}}class FloatingText{constructor(t,s){this.en=t,this.t=s,this.s=1,this.k=0,this.p={x:0,y:0},this.dx=2*mr()-1,this.dy=2*mr()}instantiate(){this.en.txts.push(this)}destroy(){let t=this.en.txts.indexOf(this);-1!==t&&this.en.txts.splice(t,1)}draw(){this.k++,this.s=20*Math.sin(this.k/60*Math.PI);let t=this.en.ctx,s=.5*this.en.w-this.en.cX,i=.5*this.en.h-this.en.cY,h=s+this.p.x+this.k*this.dx,e=i+this.p.y-2*this.k*this.dy;t.font=this.s.toFixed(0)+"px Arial",t.textAlign="center",t.fillStyle="white",t.fillText(this.t,h,e),this.k>60&&this.destroy()}}class Disc extends GameObject{constructor(t,s,i,h){super(t),this.type="disc",this.s=s,this.r=10*s,this.h=i,this.p={x:0,y:0},this.color=h,this.colorShadow=scaleColor(h,.5)}destroy(t){if(!t){let t=new DstryDisc(this);t.instantiate()}super.destroy()}draw(){let t=this.en.ctx;t.lineWidth=2;let s=.5*this.en.w-this.en.cX,i=.5*this.en.h-this.en.cY,h=s+this.p.x,e=i+this.p.y;if(h>-20-this.r&&e>-20-this.r&&h<this.en.w+20+this.r&&e<this.en.h+20+this.r){let s=this.h-2*this.h*h/this.en.w,i=this.h-2*this.h*e/this.en.h;t.beginPath(),t.arc(h+s,e+i,this.r,0,2*Math.PI),t.strokeStyle=this.colorShadow,t.stroke(),t.beginPath(),t.arc(h,e,this.r,0,2*Math.PI),t.strokeStyle=this.color,t.stroke()}}collide(t,s,i){let h=t-this.p.x,e=s-this.p.y,n=h*h+e*e;return n<(i+this.r)*(i+this.r)}collisionNormal(t,s,i){let h=t-this.p.x,e=s-this.p.y,n=h*h+e*e;if(n<(i+this.r)*(i+this.r)){let t=Math.sqrt(n),s={x:h/t,y:e/t};return s}}}class DstryDisc extends Disc{constructor(t){super(t.t,t.s,t.h,t.color),this.type="dstryd",this.p=t.p}destroy(){super.destroy(!0)}update(){this.r*=.8,this.r<1&&this.destroy()}}class Structure extends GameObject{constructor(t,s){super(t),this.dir=0,this.k=0,this.p={x:0,y:0},this.r=s,this.a=0}instantiate(){this.en.gos.push(this),this.coins.forEach(t=>{t.instantiate()}),this.spikes.forEach(t=>{t.instantiate()})}destroy(){let t=this.en.gos.indexOf(this);-1!==t&&this.en.gos.splice(t,1),t=this.t.strs.indexOf(this),-1!==t&&this.t.strs.splice(t,1),this.coins.forEach(t=>{t.destroy()}),this.spikes.forEach(t=>{t.destroy()})}check(){let t=!1;return this.coins.forEach(s=>{s.dstryd||(t=!0)}),t?(t=!1,this.spikes.forEach(s=>{s.dstryd||(t=!0)}),!!t||(this.destroy(),!1)):(this.destroy(),!1)}update(){let t=mc(this.dir),s=mc(this.dir);this.p.x+=.2*t,this.p.y+=.2*s,this.dir=mc(this.k/1e3)*Math.PI,this.k++,this.a+=Math.PI/1200}}class Tunnel extends Structure{constructor(t,s){super(t,s),this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5)]}update(){if(this.check()){super.update();let t=mc(this.a),s=ms(this.a);this.coins.forEach((i,h)=>{i.p.x=t*this.r*(h-2)/3+this.p.x,i.p.y=s*this.r*(h-2)/3+this.p.y}),this.spikes.forEach((i,h)=>{let e=this.coins[h],n=h%2==0?1:-1;i.p.x=e.p.x+n*s*this.r/3,i.p.y=e.p.y-n*t*this.r/3})}}}class Shell extends Structure{constructor(t,s){super(t,s),this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5)]}update(){this.check()&&(super.update(),this.coins.forEach((t,s)=>{let i=mc(this.a+s*Math.PI/2),h=ms(this.a+s*Math.PI/2);t.p.x=i*this.r/3+this.p.x,t.p.y=h*this.r/3+this.p.y}),this.spikes.forEach((t,s)=>{let i=mc(this.a+s*Math.PI/2),h=ms(this.a+s*Math.PI/2);t.p.x=i*this.r+this.p.x,t.p.y=h*this.r+this.p.y}))}}class HotCore extends Structure{constructor(t,s){super(t,s),this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5),new Spike(t,1,5)]}update(){this.check()&&(super.update(),this.coins.forEach((t,s)=>{let i=mc(this.a+s*Math.PI/2),h=ms(this.a+s*Math.PI/2);t.p.x=i*this.r+this.p.x,t.p.y=h*this.r+this.p.y}),this.spikes.forEach((t,s)=>{let i=mc(this.a+s*Math.PI/2+Math.PI/4),h=ms(this.a+s*Math.PI/2+Math.PI/4);t.p.x=i*this.r*.5+this.p.x,t.p.y=h*this.r*.5+this.p.y}))}}class Snake extends Structure{constructor(t,s){super(t),this.l=s,this.r=s/6,this.coins=[new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5),new Coin(t,2,5)],this.spikes=[new Spike(t,1,5)]}update(){if(this.check()){let t=this.en.blob,s=t.pN.x-this.p.x,i=t.pN.y-this.p.y,h=Math.sqrt(s*s+i*i);s/=h,i/=h,h<800?(this.p.x+=s,this.p.y+=i):super.update(),this.spikes[0].p.x=this.p.x,this.spikes[0].p.y=this.p.y;let e=this.spikes[0];for(let t=0;t<this.coins.length;t++){let s=this.coins[t];if(s){let t=s.p.x-e.p.x,i=s.p.y-e.p.y,h=t*t+i*i;h>this.r*this.r&&(h=Math.sqrt(h),t/=h,i/=h,s.p.x=e.p.x+t*this.r,s.p.y=e.p.y+i*this.r),e=s}}}}}var coins=[];class Coin extends Disc{constructor(t,s,i){super(t,s,i,"#b5eecb"),this.type="coin"}instantiate(){super.instantiate(),coins.push(this)}destroy(){super.destroy();let t=coins.indexOf(this);-1!==t&&coins.splice(t,1),t=this.t.cons.indexOf(this),-1!==t&&this.t.cons.splice(t,1)}}class Spike extends Disc{constructor(t,s,i){super(t,s,i,"#f8a2a8"),this.type="spike"}destroy(){super.destroy();let t=this.t.spks.indexOf(this);-1!==t&&this.t.spks.splice(t,1)}}class Stone extends Disc{constructor(t,s,i){super(t,s,i,"#9589a9"),this.type="stone",this.bump=0,this.bumping=!1}draw(){this.bumping?(this.bump+=1+.5*this.s,this.bumping=this.bump<3*this.size):this.bump=Math.max(this.bump-.5,0);let t=this.en.ctx;t.lineWidth=2;let s=.5*this.en.w-this.en.cX,i=.5*this.en.h-this.en.cY,h=s+this.p.x,e=i+this.p.y;if(h>-20-this.r&&e>-20-this.r&&h<this.en.w+20+this.r&&e<this.en.h+20+this.r){let s=this.h-2*this.h*h/this.en.w,i=this.h-2*this.h*e/this.en.h;t.beginPath(),t.arc(h+s,e+i,this.r+this.bump,0,2*Math.PI),t.strokeStyle=this.colorShadow,t.stroke(),t.beginPath(),t.arc(h,e,this.r+this.bump,0,2*Math.PI),t.strokeStyle=this.color,t.stroke()}}}class Blob{constructor(t){this.en=t,this.combo=1,this.hpM=20,this.hp=this.hpM,this.springK=6,this.mBod=3,this.mNuc=1,this.nFrz=!1,this.nT=1,this.pN={x:50,y:30},this.vN={x:0,y:0},this.pB={x:-50,y:20},this.vB={x:0,y:0},this.pA={x:0,y:0}}draw(){if(!playing)return;let t=this.en.ctx,s=.5*this.en.w-this.en.cX,i=.5*this.en.h-this.en.cY,h=20,e=30,n=this.pB.x-this.pN.x,r=this.pB.y-this.pN.y,p=Math.sqrt(n*n+r*r);n/=p,r/=p,e-=p/10,e=Math.max(e,h);let o=lerpColor(cGrn,cBlk,1-this.hp/this.hpM);t.beginPath(),t.arc(s+this.pB.x,i+this.pB.y,e+2,0,2*Math.PI),t.fillStyle=o,t.fill();for(let e=0;e<.5*p;e+=2){let o=1-e/(.5*p);o*=o;let a=h*o+.5*h*(1-o);t.beginPath(),t.arc(s+this.pN.x+n*e,i+this.pN.y+r*e,a+2,0,2*Math.PI),t.fill()}for(let o=.5*p;o<p;o+=2){let a=(o-.5*p)/(.5*p);a=Math.pow(a,1.5);let l=.5*h*(1-a)+e*a;t.beginPath(),t.arc(s+this.pN.x+n*o,i+this.pN.y+r*o,l+2,0,2*Math.PI),t.fill()}t.beginPath(),t.arc(s+this.pN.x,i+this.pN.y,h+2,0,2*Math.PI),t.fill(),t.fillStyle=cBlk,t.beginPath(),t.arc(s+this.pB.x,i+this.pB.y,e,0,2*Math.PI),t.fill();for(let e=0;e<.5*p;e+=2){let o=1-e/(.5*p);o*=o;let a=h*o+.5*h*(1-o);t.beginPath(),t.arc(s+this.pN.x+n*e,i+this.pN.y+r*e,a,0,2*Math.PI),t.fill()}for(let o=.5*p;o<p;o+=2){let a=(o-.5*p)/(.5*p);a=Math.pow(a,1.5);let l=.5*h*(1-a)+e*a;t.beginPath(),t.arc(s+this.pN.x+n*o,i+this.pN.y+r*o,l,0,2*Math.PI),t.fill()}t.beginPath(),t.arc(s+this.pN.x,i+this.pN.y,h,0,2*Math.PI),t.fill()}update(){this.hp<=0&&gameover(),this.nFrz?this.nT-=1/120:(this.nT+=1/90,this.nT=Math.min(this.nT,1)),this.nT<0&&(this.nFrz=!1,this.nT=0);let t=this.pB.x-this.pN.x,s=this.pB.y-this.pN.y,i=Math.sqrt(t*t+s*s);if(i>0){t/=i,s/=i;let h=-t,e=-s;this.vN.x+=t*i*this.springK/60/this.mNuc,this.vN.y+=s*i*this.springK/60/this.mNuc,this.vB.x+=h*i*this.springK/60/this.mBod,this.vB.y+=e*i*this.springK/60/this.mBod}coins=coins.sort((t,s)=>{let i=t.p.x-this.pN.x;i*=i;let h=t.p.y-this.pN.y;h*=h;let e=s.p.x-this.pN.x;e*=e;let n=s.p.y-this.pN.y;return n*=n,i+h-(e+n)});let h=coins[0];if(h){let t=h.p.x-this.pN.x,s=h.p.y-this.pN.y,i=Math.sqrt(t*t+s*s);if(i>0){t/=i,s/=i;let h=50/(i/100)/(i/100);t*=h/60/this.mNuc,s*=h/60/this.mNuc,this.vN.x+=t,this.vN.y+=s}}if(this.nFrz){let t=this.pA.x-this.pB.x,s=this.pA.y-this.pB.y,i=Math.sqrt(t*t+s*s);i>0&&(t/=i,s/=i,this.vB.x+=t*i*this.springK*100/60/this.mBod,this.vB.y+=s*i*this.springK*100/60/this.mBod)}this.vN.x*=.99*this.nT,this.vN.y*=.99*this.nT,this.vB.x*=.9925*(.8+(this.nFrz?0:.2)),this.vB.y*=.9925*(.8+(this.nFrz?0:.2));for(let t=0;t<this.en.gos.length;t++){let s=this.en.gos[t];if(s.collide){let t=s.collide(this.pB.x,this.pB.y,30);if(t)if("stone"===s.type){let t=s.collisionNormal(this.pB.x,this.pB.y,30),i=this.vB.x*t.x+this.vB.y*t.y;this.pB.x=s.p.x+t.x*(30+s.r+1),this.pB.y=s.p.y+t.y*(30+s.r+1),this.vB.x-=2*i*t.x,this.vB.y-=2*i*t.y,s.bumping=!0;let h=new FloatingText(this.en,"BUMP !");h.p.x=this.pB.x,h.p.y=this.pB.y,h.instantiate()}else"spike"===s.type&&(this.hp=Math.max(this.hp-s.s,0),s.destroy(),this.combo=1);let i=s.collide(this.pN.x,this.pN.y,20);if(i)if("stone"===s.type){let t=s.collisionNormal(this.pN.x,this.pN.y,20),i=this.vN.x*t.x+this.vN.y*t.y;this.pN.x=s.p.x+t.x*(20+s.r+1),this.pN.y=s.p.y+t.y*(20+s.r+1),this.vN.x-=2*i*t.x,this.vN.y-=2*i*t.y,s.bumping=!0;let h=new FloatingText(this.en,"BUMP !");h.p.x=this.pN.x,h.p.y=this.pN.y,h.instantiate()}else if("coin"===s.type){sc+=s.s*this.combo;let t=new FloatingText(this.en,"+ "+(s.s*this.combo).toFixed(0));t.p.x=this.pB.x,t.p.y=this.pB.y,t.instantiate(),s.destroy(),this.combo+=1}else"spike"===s.type&&(this.hp=Math.max(this.hp-s.s,0),s.destroy(),this.combo=1)}}this.pN.x+=this.vN.x/60,this.pN.y+=this.vN.y/60,this.pB.x+=this.vB.x/60,this.pB.y+=this.vB.y/60}}var cw=700,ch=700,playing=!1;window.addEventListener("load",()=>{let t=document.getElementById("play");t.style.width="300px",t.style.left="200px",t.style.top="300px",play(),requestAnimationFrame(gameover)});